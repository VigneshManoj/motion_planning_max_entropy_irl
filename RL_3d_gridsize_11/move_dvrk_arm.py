import rospy
import dvrk
import PyKDL
import numpy as np
# from read_write_joint_to_file import DataCollection
from robot_state_utils import RobotStateUtils


if __name__ == '__main__':
    rospy.init_node('move_dvrk_arm')
    p = dvrk.psm('PSM2')
    p.home()
    rospy_rate = 10
    # read_obj = DataCollection(rospy_rate, file_dir)
    # move_dvrk_obj = MoveDVRKArm(rospy_rate)
    # df = read_obj.data_parse_df_numpy_arr()
    # print df[1:3],  "\nhi\n", df[1:3][0], df[1:3][2], "\nhi\n", df.shape[0]
    starting_point = np.array([-0.008, 0.053, -0.134])
    policy = np.array(
        [26.00000, 23.00000, 26.00000, 25.00000, 24.00000, 15.00000, 15.00000, 15.00000, 12.00000, 21.00000, 12.00000,
         17.00000, 26.00000, 23.00000, 22.00000, 21.00000, 12.00000, 15.00000, 12.00000, 15.00000, 18.00000, 9.00000,
         14.00000, 26.00000, 20.00000, 19.00000, 18.00000, 9.00000, 12.00000, 15.00000, 12.00000, 24.00000, 21.00000,
         11.00000, 23.00000, 11.00000, 10.00000, 9.00000, 9.00000, 9.00000, 12.00000, 9.00000, 21.00000, 18.00000,
         11.00000, 20.00000, 19.00000, 18.00000, 18.00000, 9.00000, 9.00000, 9.00000, 9.00000, 18.00000, 21.00000,
         11.00000, 11.00000, 10.00000, 9.00000, 10.00000, 9.00000, 9.00000, 18.00000, 9.00000, 9.00000, 18.00000,
         20.00000, 20.00000, 19.00000, 18.00000, 18.00000, 19.00000, 18.00000, 9.00000, 18.00000, 9.00000, 21.00000,
         11.00000, 10.00000, 11.00000, 10.00000, 9.00000, 18.00000, 10.00000, 9.00000, 18.00000, 9.00000, 18.00000,
         20.00000, 19.00000, 18.00000, 18.00000, 18.00000, 18.00000, 18.00000, 10.00000, 9.00000, 18.00000, 9.00000,
         19.00000, 20.00000, 19.00000, 18.00000, 20.00000, 19.00000, 18.00000, 9.00000, 18.00000, 18.00000, 18.00000,
         11.00000, 10.00000, 9.00000, 10.00000, 20.00000, 19.00000, 18.00000, 18.00000, 9.00000, 18.00000, 18.00000,
         17.00000, 14.00000, 17.00000, 16.00000, 15.00000, 6.00000, 6.00000, 6.00000, 21.00000, 12.00000, 3.00000,
         8.00000, 17.00000, 14.00000, 13.00000, 12.00000, 3.00000, 6.00000, 3.00000, 6.00000, 9.00000, 0.00000, 5.00000,
         17.00000, 11.00000, 10.00000, 9.00000, 0.00000, 3.00000, 6.00000, 3.00000, 15.00000, 12.00000, 2.00000,
         14.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 3.00000, 0.00000, 12.00000, 9.00000, 2.00000, 11.00000,
         10.00000, 9.00000, 9.00000, 0.00000, 0.00000, 0.00000, 0.00000, 9.00000, 12.00000, 20.00000, 20.00000,
         19.00000, 18.00000, 1.00000, 0.00000, 0.00000, 9.00000, 0.00000, 0.00000, 9.00000, 20.00000, 11.00000,
         20.00000, 19.00000, 18.00000, 10.00000, 9.00000, 0.00000, 9.00000, 18.00000, 18.00000, 20.00000, 19.00000,
         18.00000, 19.00000, 18.00000, 18.00000, 1.00000, 0.00000, 9.00000, 0.00000, 9.00000, 19.00000, 18.00000,
         20.00000, 19.00000, 18.00000, 18.00000, 18.00000, 18.00000, 18.00000, 18.00000, 18.00000, 10.00000, 11.00000,
         10.00000, 20.00000, 19.00000, 18.00000, 9.00000, 0.00000, 18.00000, 18.00000, 18.00000, 2.00000, 1.00000,
         0.00000, 18.00000, 20.00000, 19.00000, 18.00000, 9.00000, 0.00000, 19.00000, 18.00000, 8.00000, 5.00000,
         8.00000, 7.00000, 6.00000, 6.00000, 3.00000, 6.00000, 12.00000, 3.00000, 12.00000, 8.00000, 8.00000, 5.00000,
         4.00000, 3.00000, 3.00000, 6.00000, 6.00000, 9.00000, 0.00000, 6.00000, 5.00000, 8.00000, 2.00000, 1.00000,
         0.00000, 0.00000, 3.00000, 3.00000, 12.00000, 6.00000, 3.00000, 17.00000, 5.00000, 2.00000, 1.00000, 0.00000,
         0.00000, 0.00000, 0.00000, 9.00000, 3.00000, 0.00000, 26.00000, 2.00000, 1.00000, 0.00000, 0.00000, 9.00000,
         18.00000, 9.00000, 0.00000, 0.00000, 3.00000, 23.00000, 20.00000, 19.00000, 18.00000, 9.00000, 9.00000,
         18.00000, 0.00000, 0.00000, 9.00000, 0.00000, 20.00000, 19.00000, 18.00000, 18.00000, 9.00000, 1.00000,
         0.00000, 18.00000, 0.00000, 9.00000, 9.00000, 11.00000, 10.00000, 20.00000, 19.00000, 18.00000, 9.00000,
         19.00000, 18.00000, 0.00000, 18.00000, 0.00000, 10.00000, 9.00000, 11.00000, 10.00000, 9.00000, 18.00000,
         9.00000, 19.00000, 18.00000, 9.00000, 9.00000, 1.00000, 2.00000, 1.00000, 11.00000, 10.00000, 9.00000,
         18.00000, 9.00000, 18.00000, 18.00000, 9.00000, 11.00000, 10.00000, 9.00000, 9.00000, 11.00000, 10.00000,
         9.00000, 0.00000, 18.00000, 10.00000, 9.00000, 17.00000, 5.00000, 8.00000, 7.00000, 6.00000, 15.00000, 3.00000,
         6.00000, 3.00000, 6.00000, 3.00000, 8.00000, 2.00000, 5.00000, 4.00000, 3.00000, 12.00000, 0.00000, 3.00000,
         0.00000, 3.00000, 0.00000, 5.00000, 8.00000, 2.00000, 1.00000, 0.00000, 9.00000, 3.00000, 0.00000, 3.00000,
         15.00000, 18.00000, 8.00000, 5.00000, 4.00000, 3.00000, 0.00000, 0.00000, 0.00000, 3.00000, 0.00000, 12.00000,
         6.00000, 17.00000, 2.00000, 1.00000, 0.00000, 1.00000, 0.00000, 9.00000, 0.00000, 9.00000, 9.00000, 6.00000,
         14.00000, 11.00000, 10.00000, 9.00000, 0.00000, 0.00000, 18.00000, 18.00000, 0.00000, 0.00000, 3.00000,
         11.00000, 10.00000, 9.00000, 9.00000, 0.00000, 18.00000, 18.00000, 18.00000, 9.00000, 0.00000, 0.00000,
         2.00000, 20.00000, 11.00000, 10.00000, 9.00000, 0.00000, 19.00000, 18.00000, 9.00000, 18.00000, 9.00000,
         1.00000, 0.00000, 2.00000, 1.00000, 0.00000, 9.00000, 0.00000, 19.00000, 18.00000, 0.00000, 0.00000, 2.00000,
         1.00000, 20.00000, 19.00000, 18.00000, 18.00000, 9.00000, 18.00000, 18.00000, 9.00000, 0.00000, 20.00000,
         19.00000, 18.00000, 20.00000, 19.00000, 18.00000, 0.00000, 18.00000, 18.00000, 1.00000, 0.00000, 8.00000,
         8.00000, 8.00000, 8.00000, 7.00000, 6.00000, 3.00000, 3.00000, 6.00000, 3.00000, 15.00000, 5.00000, 5.00000,
         5.00000, 5.00000, 4.00000, 3.00000, 0.00000, 6.00000, 6.00000, 0.00000, 12.00000, 8.00000, 2.00000, 2.00000,
         2.00000, 1.00000, 0.00000, 0.00000, 3.00000, 6.00000, 6.00000, 9.00000, 8.00000, 8.00000, 7.00000, 11.00000,
         10.00000, 9.00000, 9.00000, 0.00000, 3.00000, 3.00000, 9.00000, 8.00000, 5.00000, 4.00000, 3.00000, 19.00000,
         18.00000, 0.00000, 0.00000, 0.00000, 0.00000, 6.00000, 5.00000, 2.00000, 1.00000, 0.00000, 19.00000, 18.00000,
         9.00000, 9.00000, 0.00000, 0.00000, 3.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 9.00000, 9.00000,
         9.00000, 0.00000, 0.00000, 0.00000, 2.00000, 11.00000, 2.00000, 1.00000, 0.00000, 0.00000, 18.00000, 9.00000,
         0.00000, 9.00000, 0.00000, 11.00000, 20.00000, 20.00000, 19.00000, 18.00000, 0.00000, 18.00000, 18.00000,
         9.00000, 18.00000, 0.00000, 20.00000, 20.00000, 11.00000, 10.00000, 9.00000, 9.00000, 0.00000, 18.00000,
         18.00000, 0.00000, 0.00000, 11.00000, 10.00000, 9.00000, 11.00000, 10.00000, 9.00000, 0.00000, 9.00000,
         9.00000, 18.00000, 18.00000, 5.00000, 5.00000, 8.00000, 8.00000, 7.00000, 6.00000, 3.00000, 3.00000, 6.00000,
         6.00000, 6.00000, 8.00000, 2.00000, 8.00000, 5.00000, 4.00000, 3.00000, 6.00000, 0.00000, 6.00000, 3.00000,
         3.00000, 5.00000, 5.00000, 5.00000, 2.00000, 1.00000, 0.00000, 3.00000, 3.00000, 3.00000, 0.00000, 0.00000,
         8.00000, 2.00000, 2.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 0.00000, 3.00000, 0.00000, 5.00000,
         4.00000, 3.00000, 11.00000, 10.00000, 9.00000, 9.00000, 9.00000, 0.00000, 0.00000, 15.00000, 2.00000, 1.00000,
         0.00000, 11.00000, 10.00000, 9.00000, 0.00000, 0.00000, 0.00000, 0.00000, 12.00000, 2.00000, 1.00000, 0.00000,
         0.00000, 0.00000, 19.00000, 18.00000, 0.00000, 9.00000, 0.00000, 9.00000, 2.00000, 2.00000, 1.00000, 0.00000,
         0.00000, 0.00000, 18.00000, 0.00000, 18.00000, 0.00000, 9.00000, 2.00000, 11.00000, 11.00000, 10.00000,
         9.00000, 0.00000, 9.00000, 9.00000, 18.00000, 9.00000, 0.00000, 20.00000, 11.00000, 2.00000, 1.00000, 0.00000,
         0.00000, 9.00000, 9.00000, 18.00000, 18.00000, 0.00000, 2.00000, 1.00000, 0.00000, 2.00000, 1.00000, 0.00000,
         18.00000, 0.00000, 0.00000, 9.00000, 9.00000, 8.00000, 8.00000, 5.00000, 4.00000, 3.00000, 4.00000, 3.00000,
         3.00000, 3.00000, 3.00000, 15.00000, 5.00000, 5.00000, 2.00000, 8.00000, 7.00000, 6.00000, 6.00000, 0.00000,
         0.00000, 0.00000, 6.00000, 8.00000, 8.00000, 5.00000, 8.00000, 7.00000, 6.00000, 3.00000, 0.00000, 0.00000,
         0.00000, 6.00000, 5.00000, 5.00000, 2.00000, 5.00000, 4.00000, 3.00000, 0.00000, 3.00000, 6.00000, 3.00000,
         3.00000, 2.00000, 2.00000, 2.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 3.00000, 0.00000, 6.00000,
         4.00000, 3.00000, 23.00000, 0.00000, 1.00000, 0.00000, 0.00000, 9.00000, 0.00000, 0.00000, 3.00000, 1.00000,
         0.00000, 20.00000, 20.00000, 19.00000, 18.00000, 9.00000, 9.00000, 0.00000, 9.00000, 0.00000, 2.00000, 1.00000,
         0.00000, 0.00000, 19.00000, 18.00000, 9.00000, 18.00000, 9.00000, 0.00000, 0.00000, 2.00000, 2.00000, 2.00000,
         1.00000, 0.00000, 0.00000, 0.00000, 0.00000, 9.00000, 0.00000, 18.00000, 11.00000, 2.00000, 11.00000, 10.00000,
         9.00000, 0.00000, 0.00000, 0.00000, 9.00000, 9.00000, 21.00000, 1.00000, 20.00000, 19.00000, 18.00000,
         18.00000, 9.00000, 9.00000, 18.00000, 1.00000, 0.00000, 18.00000, 8.00000, 8.00000, 8.00000, 8.00000, 7.00000,
         6.00000, 6.00000, 3.00000, 3.00000, 12.00000, 21.00000, 8.00000, 5.00000, 5.00000, 5.00000, 8.00000, 7.00000,
         6.00000, 6.00000, 0.00000, 9.00000, 18.00000, 8.00000, 2.00000, 8.00000, 7.00000, 6.00000, 4.00000, 3.00000,
         6.00000, 0.00000, 6.00000, 0.00000, 5.00000, 26.00000, 5.00000, 8.00000, 7.00000, 6.00000, 0.00000, 3.00000,
         6.00000, 3.00000, 21.00000, 2.00000, 23.00000, 2.00000, 5.00000, 4.00000, 3.00000, 0.00000, 0.00000, 3.00000,
         0.00000, 18.00000, 2.00000, 20.00000, 14.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 0.00000, 3.00000,
         6.00000, 1.00000, 20.00000, 11.00000, 11.00000, 10.00000, 9.00000, 0.00000, 0.00000, 0.00000, 0.00000, 3.00000,
         4.00000, 2.00000, 20.00000, 19.00000, 18.00000, 9.00000, 0.00000, 9.00000, 0.00000, 0.00000, 0.00000, 1.00000,
         0.00000, 2.00000, 2.00000, 1.00000, 0.00000, 9.00000, 9.00000, 0.00000, 21.00000, 9.00000, 2.00000, 1.00000,
         2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 1.00000, 0.00000, 18.00000, 12.00000, 1.00000, 11.00000, 10.00000,
         9.00000, 9.00000, 0.00000, 0.00000, 9.00000, 1.00000, 0.00000, 9.00000, 8.00000, 5.00000, 4.00000, 5.00000,
         8.00000, 7.00000, 6.00000, 6.00000, 3.00000, 3.00000, 12.00000, 5.00000, 8.00000, 7.00000, 8.00000, 7.00000,
         6.00000, 6.00000, 6.00000, 6.00000, 0.00000, 9.00000, 8.00000, 8.00000, 8.00000, 7.00000, 8.00000, 7.00000,
         6.00000, 6.00000, 6.00000, 0.00000, 9.00000, 5.00000, 17.00000, 8.00000, 8.00000, 7.00000, 6.00000, 3.00000,
         3.00000, 6.00000, 3.00000, 12.00000, 2.00000, 14.00000, 8.00000, 8.00000, 7.00000, 6.00000, 0.00000, 0.00000,
         3.00000, 0.00000, 9.00000, 14.00000, 11.00000, 5.00000, 5.00000, 4.00000, 3.00000, 0.00000, 6.00000, 0.00000,
         9.00000, 3.00000, 11.00000, 11.00000, 2.00000, 2.00000, 1.00000, 0.00000, 0.00000, 3.00000, 0.00000, 0.00000,
         0.00000, 20.00000, 11.00000, 11.00000, 10.00000, 9.00000, 0.00000, 9.00000, 0.00000, 3.00000, 15.00000,
         3.00000, 20.00000, 20.00000, 2.00000, 1.00000, 0.00000, 9.00000, 0.00000, 0.00000, 0.00000, 12.00000, 0.00000,
         2.00000, 2.00000, 11.00000, 2.00000, 2.00000, 1.00000, 0.00000, 10.00000, 9.00000, 9.00000, 21.00000, 1.00000,
         2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 1.00000, 0.00000, 18.00000, 8.00000, 8.00000,
         8.00000, 8.00000, 7.00000, 8.00000, 7.00000, 6.00000, 3.00000, 6.00000, 3.00000, 5.00000, 5.00000, 8.00000,
         8.00000, 8.00000, 8.00000, 7.00000, 6.00000, 6.00000, 6.00000, 0.00000, 17.00000, 8.00000, 8.00000, 8.00000,
         7.00000, 6.00000, 6.00000, 3.00000, 3.00000, 6.00000, 0.00000, 17.00000, 8.00000, 7.00000, 6.00000, 4.00000,
         3.00000, 6.00000, 0.00000, 0.00000, 6.00000, 3.00000, 8.00000, 5.00000, 4.00000, 3.00000, 7.00000, 6.00000,
         3.00000, 0.00000, 0.00000, 3.00000, 0.00000, 5.00000, 2.00000, 8.00000, 7.00000, 6.00000, 3.00000, 0.00000,
         3.00000, 0.00000, 0.00000, 9.00000, 2.00000, 2.00000, 5.00000, 4.00000, 3.00000, 0.00000, 0.00000, 0.00000,
         6.00000, 0.00000, 9.00000, 11.00000, 2.00000, 2.00000, 1.00000, 0.00000, 1.00000, 0.00000, 0.00000, 3.00000,
         6.00000, 0.00000, 11.00000, 11.00000, 10.00000, 9.00000, 9.00000, 0.00000, 0.00000, 9.00000, 0.00000, 3.00000,
         9.00000, 20.00000, 20.00000, 2.00000, 1.00000, 0.00000, 1.00000, 0.00000, 1.00000, 0.00000, 0.00000, 12.00000,
         10.00000, 9.00000, 2.00000, 2.00000, 1.00000, 0.00000, 0.00000, 11.00000, 10.00000, 9.00000, 9.00000, 4.00000,
         3.00000, 5.00000, 4.00000, 8.00000, 8.00000, 8.00000, 7.00000, 6.00000, 6.00000, 12.00000, 8.00000, 8.00000,
         8.00000, 8.00000, 7.00000, 8.00000, 7.00000, 6.00000, 3.00000, 3.00000, 9.00000, 8.00000, 8.00000, 7.00000,
         6.00000, 8.00000, 7.00000, 6.00000, 3.00000, 0.00000, 0.00000, 6.00000, 8.00000, 8.00000, 7.00000, 6.00000,
         7.00000, 6.00000, 3.00000, 0.00000, 3.00000, 0.00000, 6.00000, 8.00000, 8.00000, 7.00000, 6.00000, 6.00000,
         3.00000, 6.00000, 3.00000, 0.00000, 0.00000, 3.00000, 8.00000, 5.00000, 4.00000, 3.00000, 3.00000, 7.00000,
         6.00000, 0.00000, 0.00000, 3.00000, 0.00000, 5.00000, 2.00000, 1.00000, 0.00000, 0.00000, 4.00000, 3.00000,
         6.00000, 3.00000, 6.00000, 0.00000, 2.00000, 5.00000, 4.00000, 3.00000, 2.00000, 1.00000, 0.00000, 3.00000,
         0.00000, 3.00000, 3.00000, 2.00000, 2.00000, 1.00000, 0.00000, 0.00000, 0.00000, 1.00000, 0.00000, 0.00000,
         0.00000, 0.00000, 11.00000, 11.00000, 10.00000, 9.00000, 10.00000, 9.00000, 0.00000, 0.00000, 9.00000, 0.00000,
         3.00000, 1.00000, 0.00000, 10.00000, 2.00000, 1.00000, 0.00000, 9.00000, 2.00000, 1.00000, 0.00000, 0.00000])

    goal_point = np.array([0.005, 0.055, -0.125])
    env_obj = RobotStateUtils(11, 0.8, goal_point)
    states = env_obj.create_state_space_model_func()
    action = env_obj.create_action_set_func()
    start_index = env_obj.get_state_val_index(starting_point)
    goal_index = env_obj.get_state_val_index(goal_point)
    done = False
    current_state_idx = start_index
    while not done:
        action_idx = policy[start_index]
        next_state = states[current_state_idx] + action[action_idx]
        p.move(PyKDL.Vector(float(next_state), float(next_state), float(next_state)))
        print "Movement is ", next_state[0], next_state[1], next_state[2]
        next_state_idx = env_obj.get_state_val_index(next_state)
        current_state_idx = next_state_idx
        if int(current_state_idx) == int(goal_index):
            done = True


